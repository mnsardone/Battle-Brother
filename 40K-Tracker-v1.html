<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>40K Match Tracker v1.0</title>
    <style>
        :root {
            --primary-color: black;
            --secondary-color: #f0f0f0;
            --background-color: #e0e0e0;
            --button-positive-bg: lightgreen;
            --button-critical-bg: red;
            --button-hover-positive-bg: mediumseagreen;
            --button-hover-critical-bg: darkred;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--background-color);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            transition: background-image 0.3s ease-in-out;
        }
        header {
            text-align: center;
            position: relative;
            margin-bottom: 20px;
        }
        h1 {
            color: var(--primary-color);
            padding: 10px;
            margin: 0;
            font-family: 'Algerian', sans-serif;
            transition: color 0.3s ease-in-out;
        }
        #live-time {
            position: absolute;
            top: 0;
            left: 20px;
            font-size: 32px;
            color: var(--primary-color);
            transition: color 0.3s ease-in-out;
        }
        #top-right-buttons {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #faction-list {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-top: 20px;
        }
        .faction {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 250px;
            gap: 15px;
            box-sizing: border-box;
        }
        .faction-title {
            font-size: 40px;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        .faction-values {
            display: flex;
            gap: 10px;
            flex-direction: column;
            align-items: center;
        }
        .faction-value {
            font-size: 30px;
            font-weight: bold;
        }
        .incrementer {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .incrementer div {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .critical-button {
            background-color: var(--button-critical-bg);
            color: var(--secondary-color);
            border: 2px solid var(--primary-color);
            transition: background-color 0.3s ease;
        }
        .critical-button:hover {
            background-color: var(--button-hover-critical-bg);
        }
        .positive-button {
            background-color: var(--button-positive-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            transition: background-color 0.3s ease;
        }
        .positive-button:hover {
            background-color: var(--button-hover-positive-bg);
        }
        #background-upload {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .history {
            margin-top: 15px;
            font-size: 0.9em;
            color: gray;
            text-align: center;
        }
        #image-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background-size: cover;
            background-position: center;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        @media (max-width: 600px) {
            .faction {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div id="live-time"></div>
        <h1 id="page-title">40K Match Tracker</h1>
        <div id="controls">
            <button onclick="addFaction()">Add Faction</button>
            <button onclick="nextCommandPhase()">Next Command Phase</button>
            <button id="undo-button" onclick="undo()" disabled>Undo</button>
        </div>
        <div id="top-right-buttons">
            <button class="critical-button" onclick="confirmResetAll()">Reset All</button>
            <button onclick="confirmSaveData()">Save</button>
            <button onclick="confirmLoadData()">Load</button>
        </div>
    </header>

    <div id="faction-list"></div>

    <div id="background-upload">
        <label>
            Background: 
            <input type="file" accept="image/*" onchange="setBackground(event)">
        </label>
        <label>
            Contrast Fix:
            <input type="checkbox" id="title-color-toggle" onchange="toggleTitleAndTimeColor()">
            <span>White</span>
        </label>
    </div>

    <script>
        let factionIdCounter = 0;
        let undoStack = []; // Tracks actions for undo functionality
        const UNDO_STACK_LIMIT = 50; // Limit for undo stack size

        function updateTime() {
            const liveTimeElement = document.getElementById("live-time");
            const now = new Date();
            liveTimeElement.textContent = now.toLocaleTimeString();
            requestAnimationFrame(updateTime);
        }
        requestAnimationFrame(updateTime); // Use requestAnimationFrame for updating the time

        function generateUniqueFactionId() {
            return `faction-${++factionIdCounter}`;
        }

        function addFaction() {
            const factionName = prompt("Enter the name of the faction:", "New Faction");
            if (factionName) {
                const factionList = document.getElementById("faction-list");
                const factionId = generateUniqueFactionId();
                const factionDiv = createFactionElement(factionId, factionName, 0, 0);
                factionList.appendChild(factionDiv);
                addUndoAction({ action: 'add', factionId }); // Track addition for undo
                updateUndoButtonState();
                updateButtonState(factionId, 'vp', 0);
                updateButtonState(factionId, 'cp', 0);
            }
        }

        function createFactionElement(factionId, name, vp, cp) {
            const factionDiv = document.createElement("div");
            factionDiv.className = "faction";
            factionDiv.id = factionId;
            factionDiv.innerHTML = `
                <div class="faction-title" id="faction-title-${factionId}">${name}</div>
                <div class="faction-values">
                    <div class="faction-value" id="vp-${factionId}">${vp} VP</div>
                    <div class="faction-value" id="cp-${factionId}">${cp} CP</div>
                </div>
                <div class="incrementer">
                    <div>
                        <button class="positive-button" onclick="changeValue('${factionId}', 'vp', 1)">+ VP</button>
                        <button id="decrement-vp-${factionId}" onclick="changeValue('${factionId}', 'vp', -1)" ${vp <= 0 ? 'disabled' : ''}>- VP</button>
                    </div>
                    <div>
                        <button class="positive-button" onclick="changeValue('${factionId}', 'cp', 1)">+ CP</button>
                        <button id="decrement-cp-${factionId}" onclick="changeValue('${factionId}', 'cp', -1)" ${cp <= 0 ? 'disabled' : ''}>- CP</button>
                    </div>
                </div>
                <button class="critical-button" onclick="removeFaction('${factionId}')">Remove Faction</button>
                <div class="history" id="history-${factionId}">No actions yet.</div>
            `;
            return factionDiv;
        }

        function changeValue(id, type, delta) {
            const valueElem = document.getElementById(`${type}-${id}`);
            let currentValue = parseInt(valueElem.textContent.split(' ')[0]);
            const oldValue = currentValue; // Save old value for undo
            currentValue += delta;
            if (currentValue < 0) currentValue = 0; // Prevent negative values
            valueElem.textContent = `${currentValue} ${type.toUpperCase()}`;
            addUndoAction({ action: 'change', factionId: id, type, oldValue }); // Track change
            addHistory(id, `${type.toUpperCase()} changed by ${delta > 0 ? '+' : ''}${delta}`);
            updateButtonState(id, type, currentValue);
            updateUndoButtonState();
        }

        function addUndoAction(action) {
            undoStack.push(action);
            if (undoStack.length > UNDO_STACK_LIMIT) {
                undoStack.shift(); // Remove the oldest action if stack exceeds limit
            }
            updateUndoButtonState();
        }

        function updateButtonState(id, type, value) {
            const decrementButton = document.getElementById(`decrement-${type}-${id}`);
            if (decrementButton) {
                decrementButton.disabled = value <= 0;
            }
        }

        function nextCommandPhase() {
            const factions = document.querySelectorAll(".faction");
            factions.forEach(faction => {
                const factionId = faction.id;
                changeValue(factionId, 'cp', 1); // Increment CP by 1
            });
        }

        function removeFaction(factionId) {
            if (confirm("Are you sure you want to remove this faction?")) {
                const faction = document.getElementById(factionId);
                const vp = parseInt(faction.querySelector(`#vp-${factionId}`).textContent, 10);
                const cp = parseInt(faction.querySelector(`#cp-${factionId}`).textContent, 10);
                const name = faction.querySelector(".faction-title").textContent;
                addUndoAction({ action: 'remove', factionId, vp, cp, name }); // Track removal
                faction.remove();
                updateUndoButtonState();
            }
        }

        function addHistory(id, action) {
            const historyElem = document.getElementById(`history-${id}`);
            historyElem.textContent = action;
        }

        function undo() {
            const lastAction = undoStack.pop();
            if (!lastAction) {
                alert("Nothing to undo!");
                return;
            }

            if (lastAction.action === 'add') {
                // Undo adding a faction
                document.getElementById(lastAction.factionId).remove();
            } else if (lastAction.action === 'remove') {
                // Undo removing a faction
                const factionList = document.getElementById("faction-list");
                const factionDiv = createFactionElement(lastAction.factionId, lastAction.name, lastAction.vp, lastAction.cp);
                factionList.appendChild(factionDiv);
                updateButtonState(lastAction.factionId, 'vp', lastAction.vp);
                updateButtonState(lastAction.factionId, 'cp', lastAction.cp);
            } else if (lastAction.action === 'change') {
                // Undo a value change
                const valueElem = document.getElementById(`${lastAction.type}-${lastAction.factionId}`);
                valueElem.textContent = `${lastAction.oldValue} ${lastAction.type.toUpperCase()}`;
                addHistory(lastAction.factionId, `${lastAction.type.toUpperCase()} reverted to ${lastAction.oldValue}`);
                updateButtonState(lastAction.factionId, lastAction.type, lastAction.oldValue);
            }
            updateUndoButtonState();
        }

        function updateUndoButtonState() {
            const undoButton = document.getElementById("undo-button");
            undoButton.disabled = undoStack.length === 0;
        }

        function confirmResetAll() {
            if (confirm("Are you sure you want to reset all factions?")) {
                resetAll();
            }
        }

        function resetAll() {
            const factionList = document.getElementById("faction-list");
            factionList.innerHTML = "";
            undoStack = [];
            updateUndoButtonState();
        }

        function confirmSaveData() {
            if (confirm("Are you sure you want to save data?")) {
                saveData();
            }
        }

        function saveData() {
            const factions = [];
            document.querySelectorAll(".faction").forEach(factionDiv => {
                const factionName = factionDiv.querySelector(".faction-title").textContent;
                const vp = parseInt(factionDiv.querySelector(`#vp-${factionDiv.id}`).textContent.split(' ')[0]);
                const cp = parseInt(factionDiv.querySelector(`#cp-${factionDiv.id}`).textContent.split(' ')[0]);
                factions.push({ factionName, vp, cp });
            });
            localStorage.setItem("factionData", JSON.stringify(factions));
        }

        function confirmLoadData() {
            if (confirm("Are you sure you want to load saved data? This will overwrite current data.")) {
                loadData();
            }
        }

        function loadData() {
            const savedData = localStorage.getItem("factionData");
            if (savedData) {
                try {
                    const factions = JSON.parse(savedData);
                    resetAll(); // Clear existing factions
                    factions.forEach(faction => {
                        const factionId = generateUniqueFactionId();
                        const factionDiv = createFactionElement(factionId, faction.factionName, faction.vp, faction.cp);
                        document.getElementById("faction-list").appendChild(factionDiv);
                        updateButtonState(factionId, 'vp', faction.vp);
                        updateButtonState(factionId, 'cp', faction.cp);
                    });
                } catch (error) {
                    alert("Failed to load saved data. The data might be corrupted.");
                    console.error("Error parsing saved data:", error);
                }
            } else {
                alert("No saved data found.");
            }
            updateUndoButtonState();
        }

        function autoSaveData() {
            saveData();
            console.log("Data auto-saved.");
        }
        setInterval(autoSaveData, 300000); // Auto-save every 5 minutes

        function setBackground(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.body.style.backgroundImage = `url('${e.target.result}')`;
            };
            reader.readAsDataURL(file);
        }

        function toggleTitleAndTimeColor() {
            const title = document.getElementById("page-title");
            const liveTime = document.getElementById("live-time");
            const checkbox = document.getElementById("title-color-toggle");
            const newColor = checkbox.checked ? "var(--secondary-color)" : "var(--primary-color)";
            title.style.color = newColor;
            liveTime.style.color = newColor;
        }
    </script>
<button id="toggle-player-button" style="position: fixed; bottom: 200px; left: 20px;">Hide Player</button>
<iframe width="560" height="315" src="https://www.youtube.com/embed/NfiFhQ8W7OU?si=rbuAzNz-UnwotbM3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="position: fixed; bottom: 20px; left: 20px; width: 300px; height: 170px;"></iframe>

<script>
    const toggleButton = document.getElementById('toggle-player-button');
const youtubePlayer = document.querySelector('iframe');
toggleButton.addEventListener('click', () => {
    if (youtubePlayer.style.display === 'none') {
        youtubePlayer.style.display = 'block';
        toggleButton.style.position = 'fixed';
        toggleButton.style.bottom = '200px';
        toggleButton.textContent = 'Hide Player';
    } else {
        youtubePlayer.style.display = 'none';
        toggleButton.style.position = 'fixed';
        toggleButton.style.bottom = '20px';
        toggleButton.textContent = 'Show Player';
    }
});
</script>

</body>
</html>
